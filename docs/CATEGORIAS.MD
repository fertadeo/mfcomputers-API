# üìÇ Documentaci√≥n de Categor√≠as de Productos

## üéØ Resumen

Este m√≥dulo permite gestionar las categor√≠as de productos del sistema ERP, con sincronizaci√≥n bidireccional entre WooCommerce y la API a trav√©s de n8n.

---

## üìã Estructura de Base de Datos

### Tabla `categories`

```sql
CREATE TABLE IF NOT EXISTS `categories` (
  `id` int NOT NULL AUTO_INCREMENT,
  `name` varchar(50) NOT NULL,
  `description` text,
  `is_active` tinyint(1) DEFAULT '1',
  `woocommerce_id` int DEFAULT NULL COMMENT 'ID de la categor√≠a en WooCommerce',
  `woocommerce_slug` varchar(100) DEFAULT NULL COMMENT 'Slug de la categor√≠a en WooCommerce',
  `parent_id` int DEFAULT NULL COMMENT 'Para categor√≠as jer√°rquicas',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `unique_woocommerce_id` (`woocommerce_id`),
  KEY `idx_woocommerce_slug` (`woocommerce_slug`),
  KEY `idx_parent_id` (`parent_id`),
  CONSTRAINT `fk_category_parent` FOREIGN KEY (`parent_id`) REFERENCES `categories` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;
```

### Migraci√≥n SQL

Si la tabla ya existe, ejecuta este SQL para agregar los campos de WooCommerce:

```sql
ALTER TABLE `categories` 
ADD COLUMN `woocommerce_id` INT NULL COMMENT 'ID de la categor√≠a en WooCommerce',
ADD COLUMN `woocommerce_slug` VARCHAR(100) NULL COMMENT 'Slug de la categor√≠a en WooCommerce',
ADD COLUMN `parent_id` INT NULL COMMENT 'Para categor√≠as jer√°rquicas',
ADD COLUMN `updated_at` TIMESTAMP NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
ADD UNIQUE KEY `unique_woocommerce_id` (`woocommerce_id`),
ADD KEY `idx_woocommerce_slug` (`woocommerce_slug`),
ADD KEY `idx_parent_id` (`parent_id`),
ADD CONSTRAINT `fk_category_parent` FOREIGN KEY (`parent_id`) REFERENCES `categories` (`id`) ON DELETE SET NULL;
```

---

## üîê Autenticaci√≥n

Todos los endpoints requieren autenticaci√≥n mediante API Key en el header:

```
X-API-Key: tu_api_key_aqui
```

Ver documentaci√≥n de [API Keys](./API_KEYS_DOC.md) para m√°s informaci√≥n.

---

## üì° Endpoints Disponibles

### 1. Listar todas las categor√≠as

**GET** `/api/categories`

Obtiene todas las categor√≠as activas del sistema.

**Headers:**
```
X-API-Key: tu_api_key
```

**Response 200:**
```json
{
  "success": true,
  "message": "Categor√≠as obtenidas exitosamente",
  "data": {
    "categories": [
      {
        "id": 1,
        "name": "Electr√≥nicos",
        "description": "Productos electr√≥nicos",
        "is_active": true,
        "woocommerce_id": 15,
        "woocommerce_slug": "electronicos",
        "parent_id": null,
        "created_at": "2024-01-15T10:00:00.000Z",
        "updated_at": "2024-01-15T10:00:00.000Z"
      }
    ]
  },
  "timestamp": "2024-01-15T10:00:00.000Z"
}
```

---

### 2. Obtener categor√≠a por ID

**GET** `/api/categories/:id`

Obtiene una categor√≠a espec√≠fica por su ID.

**Headers:**
```
X-API-Key: tu_api_key
```

**Parameters:**
- `id` (path): ID de la categor√≠a (n√∫mero)

**Response 200:**
```json
{
  "success": true,
  "message": "Categor√≠a obtenida exitosamente",
  "data": {
    "category": {
      "id": 1,
      "name": "Electr√≥nicos",
      "description": "Productos electr√≥nicos",
      "is_active": true,
      "woocommerce_id": 15,
      "woocommerce_slug": "electronicos",
      "parent_id": null,
      "created_at": "2024-01-15T10:00:00.000Z",
      "updated_at": "2024-01-15T10:00:00.000Z"
    }
  },
  "timestamp": "2024-01-15T10:00:00.000Z"
}
```

**Response 404:**
```json
{
  "success": false,
  "message": "Categor√≠a no encontrada",
  "timestamp": "2024-01-15T10:00:00.000Z"
}
```

---

### 3. Crear nueva categor√≠a

**POST** `/api/categories`

Crea una nueva categor√≠a en el sistema.

**Headers:**
```
X-API-Key: tu_api_key
Content-Type: application/json
```

**Body:**
```json
{
  "name": "Electr√≥nicos",
  "description": "Productos electr√≥nicos",
  "woocommerce_id": 15,
  "woocommerce_slug": "electronicos",
  "parent_id": null
}
```

**Campos:**
- `name` (string, requerido): Nombre de la categor√≠a
- `description` (string, opcional): Descripci√≥n de la categor√≠a
- `woocommerce_id` (number, opcional): ID de la categor√≠a en WooCommerce
- `woocommerce_slug` (string, opcional): Slug de la categor√≠a en WooCommerce
- `parent_id` (number, opcional): ID de la categor√≠a padre (para jerarqu√≠as)

**Response 201:**
```json
{
  "success": true,
  "message": "Categor√≠a creada exitosamente",
  "data": {
    "category": {
      "id": 1,
      "name": "Electr√≥nicos",
      "description": "Productos electr√≥nicos",
      "is_active": true,
      "woocommerce_id": 15,
      "woocommerce_slug": "electronicos",
      "parent_id": null,
      "created_at": "2024-01-15T10:00:00.000Z",
      "updated_at": "2024-01-15T10:00:00.000Z"
    }
  },
  "timestamp": "2024-01-15T10:00:00.000Z"
}
```

**Response 409 (Conflict):**
```json
{
  "success": false,
  "message": "Error creando categor√≠a",
  "error": "Ya existe una categor√≠a con ese nombre",
  "timestamp": "2024-01-15T10:00:00.000Z"
}
```

---

### 4. Actualizar categor√≠a

**PUT** `/api/categories/:id`

Actualiza una categor√≠a existente.

**Headers:**
```
X-API-Key: tu_api_key
Content-Type: application/json
```

**Parameters:**
- `id` (path): ID de la categor√≠a a actualizar

**Body:**
```json
{
  "name": "Electr√≥nicos Actualizado",
  "description": "Nueva descripci√≥n",
  "woocommerce_id": 15,
  "woocommerce_slug": "electronicos-actualizado",
  "parent_id": null,
  "is_active": true
}
```

**Campos (todos opcionales):**
- `name` (string): Nuevo nombre de la categor√≠a
- `description` (string): Nueva descripci√≥n
- `woocommerce_id` (number): ID de WooCommerce
- `woocommerce_slug` (string): Slug de WooCommerce
- `parent_id` (number): ID de categor√≠a padre
- `is_active` (boolean): Estado activo/inactivo

**Response 200:**
```json
{
  "success": true,
  "message": "Categor√≠a actualizada exitosamente",
  "data": {
    "category": {
      "id": 1,
      "name": "Electr√≥nicos Actualizado",
      "description": "Nueva descripci√≥n",
      "is_active": true,
      "woocommerce_id": 15,
      "woocommerce_slug": "electronicos-actualizado",
      "parent_id": null,
      "created_at": "2024-01-15T10:00:00.000Z",
      "updated_at": "2024-01-15T11:00:00.000Z"
    }
  },
  "timestamp": "2024-01-15T11:00:00.000Z"
}
```

**Response 404:**
```json
{
  "success": false,
  "message": "Error actualizando categor√≠a",
  "error": "Categor√≠a no encontrada",
  "timestamp": "2024-01-15T11:00:00.000Z"
}
```

---

### 5. Sincronizar categor√≠as desde WooCommerce

**POST** `/api/categories/sync/woocommerce`

**POST** `/api/woocommerce/categories/sync`

Sincroniza categor√≠as desde WooCommerce. Si la categor√≠a ya existe (por `woocommerce_id` o por nombre), se actualiza. Si no existe, se crea.

**Headers:**
```
X-API-Key: tu_api_key
Content-Type: application/json
```

**Body:**
```json
{
  "categories": [
    {
      "id": 15,
      "name": "Electr√≥nicos",
      "slug": "electronicos",
      "parent": 0
    },
    {
      "id": 16,
      "name": "Computadoras",
      "slug": "computadoras",
      "parent": 15
    }
  ]
}
```

**Campos:**
- `categories` (array, requerido): Array de categor√≠as de WooCommerce
  - `id` (number, requerido): ID de la categor√≠a en WooCommerce
  - `name` (string, requerido): Nombre de la categor√≠a
  - `slug` (string, requerido): Slug de la categor√≠a
  - `parent` (number, opcional): ID de la categor√≠a padre en WooCommerce (0 si no tiene padre)

**Response 200:**
```json
{
  "success": true,
  "message": "Sincronizaci√≥n completada. 1 creadas, 1 actualizadas.",
  "data": {
    "created": 1,
    "updated": 1,
    "errors": []
  },
  "timestamp": "2024-01-15T10:00:00.000Z"
}
```

**Response con errores:**
```json
{
  "success": true,
  "message": "Sincronizaci√≥n completada. 1 creadas, 0 actualizadas.",
  "data": {
    "created": 1,
    "updated": 0,
    "errors": [
      {
        "woocommerce_id": 17,
        "name": "Categor√≠a con error",
        "error": "Mensaje de error espec√≠fico"
      }
    ]
  },
  "timestamp": "2024-01-15T10:00:00.000Z"
}
```

---

### 6. Webhook directo de WooCommerce (RECOMENDADO)

**POST** `/api/integration/webhook/woocommerce/category`

Endpoint para recibir webhooks **directamente** de WooCommerce cuando se crea o actualiza una categor√≠a.

**Headers:**
```
X-API-Key: tu_api_key (opcional)
X-Webhook-Secret: tu_webhook_secret (alternativa)
Content-Type: application/json
```

**Autenticaci√≥n:**
Este endpoint usa `authenticateWebhook` que acepta:
- `X-API-Key`: API Key v√°lida
- `X-Webhook-Secret`: Secret configurado en `WEBHOOK_SECRET` env variable

**Body (enviado por WooCommerce):**
```json
{
  "id": 15,
  "name": "Electr√≥nicos",
  "slug": "electronicos",
  "parent": 0,
  "description": "",
  "display": "default",
  "image": null,
  "menu_order": 0,
  "count": 42
}
```

**Response 200:**
```json
{
  "success": true,
  "message": "Categor√≠a sincronizada exitosamente desde WooCommerce",
  "data": {
    "woocommerce_id": 15,
    "category_name": "Electr√≥nicos",
    "sync_result": {
      "created": 0,
      "updated": 1,
      "errors": []
    }
  },
  "timestamp": "2024-01-15T10:00:00.000Z"
}
```

**Nota:** Este endpoint procesa autom√°ticamente el payload de WooCommerce y sincroniza la categor√≠a (crea o actualiza seg√∫n corresponda).

---

### 7. Webhook gen√©rico para cambios (opcional)

**POST** `/api/categories/webhook`

Endpoint gen√©rico para recibir notificaciones de cambios en categor√≠as (puede ser usado por otros sistemas o n8n si es necesario).

**Headers:**
```
X-API-Key: tu_api_key
Content-Type: application/json
```

**Body:**
```json
{
  "action": "created",
  "category": {
    "id": 1,
    "name": "Electr√≥nicos",
    "woocommerce_id": 15
  }
}
```

**Response 200:**
```json
{
  "success": true,
  "message": "Webhook recibido correctamente",
  "data": {
    "action": "created",
    "category": {
      "id": 1,
      "name": "Electr√≥nicos",
      "woocommerce_id": 15
    }
  },
  "timestamp": "2024-01-15T10:00:00.000Z"
}
```

---

## üîÑ Sincronizaci√≥n Bidireccional con WooCommerce

### Workflow 1: WooCommerce ‚Üí API (Webhook Directo - RECOMENDADO)

Cuando se crea o actualiza una categor√≠a en WooCommerce, el webhook se env√≠a **directamente** al ERP sin intermediarios.

**Flujo:**
1. WooCommerce detecta creaci√≥n/actualizaci√≥n de categor√≠a
2. WooCommerce env√≠a webhook directamente a `POST /api/integration/webhook/woocommerce/category`
3. El ERP sincroniza autom√°ticamente la categor√≠a

**Configuraci√≥n en WooCommerce:**

1. Ve a **WooCommerce ‚Üí Settings ‚Üí Advanced ‚Üí Webhooks**
2. Haz clic en **Add webhook**
3. Configura:
   - **Name**: `ERP Category Sync`
   - **Status**: `Active`
   - **Topic**: Selecciona uno o m√°s:
     - `Product category created`
     - `Product category updated`
     - `Product category deleted` (opcional)
   - **Delivery URL**: `https://tu-api.com/api/integration/webhook/woocommerce/category`
   - **Secret**: Configura una clave secreta y agr√©galo a tu `.env` como `WEBHOOK_SECRET`

**Ejemplo de payload que WooCommerce env√≠a:**
```json
{
  "id": 15,
  "name": "Electr√≥nicos",
  "slug": "electronicos",
  "parent": 0,
  "description": "",
  "display": "default",
  "image": null,
  "menu_order": 0,
  "count": 42
}
```

El endpoint procesa autom√°ticamente este payload y sincroniza la categor√≠a en el ERP.

---

### Workflow 2: API ‚Üí WooCommerce

Cuando se crea o actualiza una categor√≠a en el ERP:

**Flujo:**
1. Se detecta cambio en categor√≠a del ERP
2. Si tiene `woocommerce_id`, actualizar en WooCommerce
3. Si no tiene `woocommerce_id`, crear en WooCommerce
4. Actualizar `woocommerce_id` en el ERP

**Crear en WooCommerce:**
```json
{
  "name": "Nueva Categor√≠a",
  "slug": "nueva-categoria",
  "parent": 0
}
```

**Actualizar en WooCommerce:**
```json
{
  "id": 15,
  "name": "Categor√≠a Actualizada",
  "slug": "categoria-actualizada"
}
```

---

## üìù Ejemplos de Uso

### Ejemplo 1: Crear categor√≠a manualmente

```bash
curl -X POST https://tu-api.com/api/categories \
  -H "X-API-Key: tu_api_key" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Accesorios",
    "description": "Accesorios para computadoras"
  }'
```

### Ejemplo 2: Sincronizar desde WooCommerce

```bash
curl -X POST https://tu-api.com/api/woocommerce/categories/sync \
  -H "X-API-Key: tu_api_key" \
  -H "Content-Type: application/json" \
  -d '{
    "categories": [
      {
        "id": 15,
        "name": "Electr√≥nicos",
        "slug": "electronicos",
        "parent": 0
      }
    ]
  }'
```

### Ejemplo 3: Actualizar categor√≠a

```bash
curl -X PUT https://tu-api.com/api/categories/1 \
  -H "X-API-Key: tu_api_key" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Electr√≥nicos Actualizado",
    "woocommerce_slug": "electronicos-actualizado"
  }'
```

### Ejemplo 4: Obtener todas las categor√≠as

```bash
curl -X GET https://tu-api.com/api/categories \
  -H "X-API-Key: tu_api_key"
```

---

## ‚öôÔ∏è Configuraci√≥n del Webhook Directo

### Paso 1: Configurar Variable de Entorno

En tu archivo `.env`:

```env
WEBHOOK_SECRET=tu_secret_seguro_aqui_muy_largo_y_aleatorio
```

### Paso 2: Configurar Webhook en WooCommerce

1. Ve a **WooCommerce Admin ‚Üí Settings ‚Üí Advanced ‚Üí Webhooks**
2. Haz clic en **Add webhook**
3. Configuraci√≥n:
   - **Name**: `ERP Category Sync`
   - **Status**: `Active`
   - **Topic**: Selecciona:
     - `Product category created`
     - `Product category updated`
     - (Opcional) `Product category deleted`
   - **Delivery URL**: 
     ```
     https://tu-dominio-api.com/api/integration/webhook/woocommerce/category
     ```
   - **Secret**: Usa el mismo valor que configuraste en `WEBHOOK_SECRET`
   - **API Version**: `WP REST API Integration v3`

4. Haz clic en **Save webhook**

### Paso 3: Verificar que Funciona

1. Crea o actualiza una categor√≠a en WooCommerce
2. El webhook se enviar√° autom√°ticamente
3. Revisa los logs de tu API para confirmar la recepci√≥n

---

## ‚öôÔ∏è Configuraci√≥n Alternativa con n8n (Opcional)

Si prefieres usar n8n como intermediario (no recomendado pero posible):

### Variables de Entorno

Configura estas variables en n8n:

```
N8N_API_KEY=tu_api_key_aqui
API_BASE_URL=https://tu-api.com/api
WC_STORE_URL=https://tu-tienda.com
WC_CONSUMER_KEY=tu_consumer_key
WC_CONSUMER_SECRET=tu_consumer_secret
```

### Workflow: Sincronizaci√≥n WooCommerce ‚Üí n8n ‚Üí API

**Nodos necesarios:**

1. **Webhook Trigger (WooCommerce)**
   - Configurar en WooCommerce ‚Üí Settings ‚Üí Advanced ‚Üí Webhooks
   - Topics: `Product category created`, `Product category updated`

2. **Function Node (Transformar datos)**
```javascript
const wcCategory = $json;

return {
  categories: [{
    id: wcCategory.id,
    name: wcCategory.name,
    slug: wcCategory.slug,
    parent: wcCategory.parent || 0
  }]
};
```

3. **HTTP Request (Sincronizar con API)**
   - Method: `POST`
   - URL: `{{$env.API_BASE_URL}}/woocommerce/categories/sync`
   - Headers:
     - `X-API-Key`: `{{$env.N8N_API_KEY}}`
     - `Content-Type`: `application/json`
   - Body: `{{$json}}`

**Nota:** Esta opci√≥n agrega complejidad innecesaria. Se recomienda usar webhook directo.

---

## üîç L√≥gica de Sincronizaci√≥n

### Al sincronizar desde WooCommerce:

1. **Buscar por `woocommerce_id`**: Si existe, actualizar
2. **Si no existe**: Buscar por nombre
   - Si existe por nombre pero no tiene `woocommerce_id`: Actualizar y agregar `woocommerce_id`
   - Si no existe: Crear nueva categor√≠a

### Al crear/actualizar en el ERP:

1. Si la categor√≠a tiene `woocommerce_id`: Actualizar en WooCommerce
2. Si no tiene `woocommerce_id`: Crear en WooCommerce y actualizar el `woocommerce_id` en el ERP

---

## ‚ö†Ô∏è Errores Comunes

### Error 409: "Ya existe una categor√≠a con ese nombre"

Soluci√≥n: Verificar que no haya otra categor√≠a con el mismo nombre o usar `woocommerce_id` para identificarla de forma √∫nica.

### Error 404: "Categor√≠a no encontrada"

Soluci√≥n: Verificar que el ID de la categor√≠a sea correcto.

### Error de sincronizaci√≥n duplicada

Soluci√≥n: Usar `woocommerce_id` para evitar duplicados. La sincronizaci√≥n autom√°tica maneja esto autom√°ticamente.

---

## üìö Archivos Relacionados

- `src/entities/Category.ts` - Entidad de categor√≠a
- `src/repositories/CategoryRepository.ts` - Repositorio de categor√≠as
- `src/services/CategoryService.ts` - Servicio de categor√≠as
- `src/controllers/categoryController.ts` - Controlador de categor√≠as
- `src/routes/categories.ts` - Rutas de categor√≠as
- `src/routes/woocommerce.ts` - Rutas de sincronizaci√≥n con WooCommerce

---

## üîó Referencias

- [Documentaci√≥n de API Keys](./API_KEYS_DOC.md)
- [Documentaci√≥n de Productos](./PRODUCTS_DOC.md)
- [Documentaci√≥n de Integraci√≥n N8N](./N8N_Integracion.md)

---

## üöÄ Configuraci√≥n R√°pida

### Resumen de Pasos para Webhook Directo:

1. ‚úÖ **Agregar `WEBHOOK_SECRET` a `.env`**
   ```env
   WEBHOOK_SECRET=tu_secret_super_seguro
   ```

2. ‚úÖ **Reiniciar el servidor** para cargar la variable de entorno

3. ‚úÖ **Configurar webhook en WooCommerce:**
   - URL: `https://tu-api.com/api/integration/webhook/woocommerce/category`
   - Secret: El mismo que `WEBHOOK_SECRET`
   - Topics: `Product category created`, `Product category updated`

4. ‚úÖ **Probar creando una categor√≠a en WooCommerce**

¬°Listo! Las categor√≠as se sincronizar√°n autom√°ticamente cuando se creen o actualicen en WooCommerce.

---

## üìù Notas

- Las categor√≠as pueden tener jerarqu√≠as usando el campo `parent_id`
- El campo `woocommerce_id` debe ser √∫nico
- Las categor√≠as inactivas (`is_active = false`) no se listan en `GET /api/categories`
- La sincronizaci√≥n bidireccional requiere configuraci√≥n correcta de webhooks en WooCommerce y n8n